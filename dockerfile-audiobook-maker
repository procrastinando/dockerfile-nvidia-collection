# Use CUDA-enabled base image with Python 3.11
FROM nvidia/cuda:12.1.1-base-ubuntu20.04

# Set environment variables
ENV DEBIAN_FRONTEND=noninteractive \
    LANG=C.UTF-8 \
    PYTHONUNBUFFERED=1 \
    CUDA_HOME=/usr/local/cuda \
    PHONEMIZER_ESPEAK_LIBRARY="/usr/local/lib/libespeak-ng.so" \
    PHONEMIZER_ESPEAK_PATH="/usr/local/share/espeak-ng"

# Update and install basic dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3.11 python3.11-venv python3.11-dev \
    git wget curl build-essential ffmpeg libespeak-ng1 libespeak-ng-dev \
    && rm -rf /var/lib/apt/lists/*

# Install pip and upgrade
RUN curl -sS https://bootstrap.pypa.io/get-pip.py | python3.11 && \
    pip install --no-cache-dir --upgrade pip setuptools wheel

# Clone the repository and set up submodules
WORKDIR /app
RUN git clone --recursive https://github.com/JarodMica/audiobook_maker.git . 

# Create and activate Python virtual environment
RUN python3.11 -m venv venv
ENV PATH="/app/venv/bin:$PATH"

# Install basic requirements
RUN pip install --no-cache-dir -r requirements.txt

# Install additional dependencies for TTS and STT engines
RUN cd modules/tortoise_tts_api && \
    pip install . && \
    cd ../../modules/styletts-api && \
    pip install . && \
    cd ../.. && \
    pip install monotonic_align-1.2-cp311-cp311-linux_x86_64.whl

# Install RVC dependencies
RUN pip install git+https://github.com/JarodMica/rvc-python.git && \
    pip install ./fairseq-0.12.4-cp311-cp311-linux_x86_64.whl

# Install PyTorch with CUDA support
RUN pip install torch==2.4.0 torchvision==0.19.0 torchaudio==2.4.0 --index-url https://download.pytorch.org/whl/cu121

# Expose the application port
EXPOSE 8000

# Command to start the application
CMD ["python", "src/controller.py"]
