# Use a CUDA-enabled base image with Python 3.11 support
FROM nvidia/cuda:12.1.1-base-ubuntu22.04

# Set environment variables
ENV DEBIAN_FRONTEND=noninteractive \
    LANG=C.UTF-8 \
    PYTHONUNBUFFERED=1 \
    CUDA_HOME=/usr/local/cuda \
    PHONEMIZER_ESPEAK_LIBRARY="/usr/local/lib/libespeak-ng.so" \
    PHONEMIZER_ESPEAK_PATH="/usr/local/share/espeak-ng"

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3.11 python3.11-venv python3.11-dev \
    git wget curl build-essential ffmpeg libespeak-ng1 libespeak-ng-dev \
    && rm -rf /var/lib/apt/lists/*

# Install pip and upgrade
RUN curl -sS https://bootstrap.pypa.io/get-pip.py | python3.11 && \
    pip install --no-cache-dir --upgrade pip setuptools wheel

# Set up working directory
WORKDIR /app

# Clone the repository and initialize submodules
RUN git clone --recursive https://github.com/JarodMica/StyleTTS-WebUI.git . && \
    git submodule init && \
    git submodule update --remote

# Create and activate Python virtual environment
RUN python3.11 -m venv venv
ENV PATH="/app/venv/bin:$PATH"

# Install PyTorch and its dependencies
RUN pip install torch==2.3.1 torchvision==0.18.1 torchaudio==2.3.1 --index-url https://download.pytorch.org/whl/cu121

# Install project requirements
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Install additional StyleTTS dependencies
RUN pip install ./modules/StyleTTS2/ && \
    python ./modules/StyleTTS2/styletts2/download_punkt.py

# Ensure proper placement of pretrained models
RUN mkdir -p models/pretrain_base_1 && \
    wget -P models/pretrain_base_1 https://huggingface.co/yl4579/StyleTTS2-LibriTTS/resolve/main/Models/LibriTTS/epochs_2nd_00020.pth && \
    wget -P models/pretrain_base_1 https://huggingface.co/yl4579/StyleTTS2-LibriTTS/resolve/main/Models/LibriTTS/config.yml

# Expose the application port
EXPOSE 8000

# Start the application
CMD ["python", "webui.py"]
