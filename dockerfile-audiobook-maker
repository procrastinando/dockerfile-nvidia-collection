# Base image with Ubuntu 22.04 and CUDA 12.1
FROM nvidia/cuda:12.1.1-base-ubuntu22.04

# Set environment variables
ENV DEBIAN_FRONTEND=noninteractive \
    PYTHONUNBUFFERED=1 \
    PATH=/root/.local/bin:$PATH

# Update and install required system packages
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3.11 python3.11-venv python3.11-dev \
    git \
    ffmpeg \
    espeak-ng \
    curl \
    build-essential \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# Clone the audiobook_maker repository
WORKDIR /app
RUN git clone https://github.com/JarodMica/audiobook_maker.git && \
    cd audiobook_maker && git submodule init && git submodule update

# Set up the Python virtual environment
WORKDIR /app/audiobook_maker
RUN python3.11 -m venv venv && \
    . ./venv/bin/activate && \
    pip install --upgrade pip && \
    pip install -r requirements.txt

# Install TortoiseTTS
RUN . ./venv/bin/activate && \
    cd modules/tortoise_tts_api && \
    git submodule init && git submodule update && \
    pip install modules/tortoise_tts modules/dlas && \
    pip install . && \
    cd ../..

# Install StyleTTS2
RUN . ./venv/bin/activate && \
    cd modules/styletts-api && \
    git submodule init && \
    git submodule update --depth 1 && \ 
    pip install modules/StyleTTS2 && \
    pip install . && \
    cd ../.. && \
    pip install git+https://github.com/resemble-ai/monotonic_align.git && \
    pip install nltk && \
    python ./modules/styletts-api/modules/StyleTTS2/styletts2/download_punkt.py

# Download StyleTTS model and config
RUN mkdir -p ./engines/styletts/base && \
    cd ./engines/styletts/base && \
    curl -L -o "epochs_2nd_00020.pth" "https://huggingface.co/yl4579/StyleTTS2-LibriTTS/resolve/d2ca3f14cf019cd2da653c74564e04f8e1f5c5ab/Models/LibriTTS/epochs_2nd_00020.pth?download=true" && \
    curl -L -o "config.yml" "https://huggingface.co/yl4579/StyleTTS2-LibriTTS/resolve/d2ca3f14cf019cd2da653c74564e04f8e1f5c5ab/Models/LibriTTS/config.yml?download=true"

# Install F5-TTS
RUN . ./venv/bin/activate && \
    pip install ./modules/F5-TTS

# Install RVC
RUN . ./venv/bin/activate && \
    pip install rvc-python

# Install fairseq (for development)
RUN . ./venv/bin/activate
RUN pip install --upgrade pip==23.2.1
RUN git clone https://github.com/pytorch/fairseq.git /opt/fairseq
WORKDIR /opt/fairseq
RUN pip install --editable ./

# Ensure the correct version of PyTorch is installed
RUN . ./venv/bin/activate && \
    pip uninstall torch -y && \
    pip install torch==2.4.0 torchvision==0.19.0 torchaudio==2.4.0 --index-url https://download.pytorch.org/whl/cu121

# Default command to activate the virtual environment and launch the interface
CMD ["/bin/bash", "-c", ". /app/audiobook_maker/venv/bin/activate && python /app/audiobook_maker/src/controller.py"]
